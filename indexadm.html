<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel Administrativo - GERA</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Reset & vars */
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --laranja:#FF8C00; --vermelho:#fc520f; --branco:#fff; --preto:#111;
      --cinza:#f5f5f5; --sombra:0 6px 20px rgba(0,0,0,.08); --trans:all .25s ease;
    }
    body{font-family:Inter,Segoe UI,system-ui,Arial,sans-serif;background:var(--cinza);color:var(--preto);min-height:100vh}
    a{color:inherit;text-decoration:none}

    /* header mobile */
    .admin-header{display:none;padding:14px;background:var(--branco);border-bottom:1px solid #eee;position:sticky;top:0;z-index:60;align-items:center;justify-content:space-between}
    .menu-toggle{background:none;border:0;font-size:20px;cursor:pointer;padding:6px;border-radius:8px}
    .logo-mobile{font-weight:700;color:var(--preto);display:flex;align-items:center;gap:8px}

    /* layout */
    .admin-container{display:flex;min-height:100vh}
    .sidebar{width:260px;background:#243243;color:#fff;padding:18px 12px;position:fixed;height:100vh;overflow:auto;box-shadow:3px 0 18px rgba(0,0,0,.08)}
    .logo-admin{font-size:18px;font-weight:700;display:flex;align-items:center;gap:10px;padding:8px 12px;margin-bottom:18px}
    .nav-item{display:flex;gap:12px;align-items:center;padding:12px;border-radius:8px;margin:6px 8px;cursor:pointer;font-weight:600}
    .nav-item:hover{background:rgba(255,255,255,0.05)}
    .nav-item.active{background:rgba(255,200,50,0.08);border-left:3px solid var(--laranja);}

    .main-content{flex:1;margin-left:260px;padding:26px;transition:var(--trans)}
    .header-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:12px}
    .header-bar h1{font-size:22px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:22px}
    .stat-card{background:var(--branco);padding:18px;border-radius:12px;box-shadow:var(--sombra);}

    .table-container{background:var(--branco);border-radius:12px;box-shadow:var(--sombra);overflow:hidden}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 14px;text-align:left;border-bottom:1px solid #eee}
    th{background:#fafafa;font-weight:700}

    .btn{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .btn-primary{background:var(--laranja);color:#fff}
    .btn-secondary{background:#efefef}
    .btn-danger{background:#e74c3c;color:#fff}

    /* modals */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:120;align-items:center;justify-content:center;padding:20px}
    .modal-content{background:var(--branco);border-radius:12px;padding:18px;width:100%;max-width:820px;max-height:90vh;overflow:auto;box-shadow:var(--sombra)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .close-modal{cursor:pointer;font-size:20px;padding:6px;border-radius:8px}

    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}

    /* previews */
    .image-preview{height:160px;background:#fbfbfb;border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden}

    /* responsive */
@media (max-width: 900px){
  .sidebar {
    position: fixed;
    left: 0;
    top: 0;
    height: 100vh;
    width: 260px;
    transform: translateX(-100%);
    transition: transform 0.25s ease;
    z-index: 200;
  }
  .sidebar.open {
    transform: translateX(0);
  }
  .main-content {
    margin-left: 0;
    padding: 18px;
  }
  .admin-header {
    display: flex;
  }
}

    /* small adjustments */
    .not-found{padding:28px;text-align:center;color:#666}
    .tag{display:inline-block;padding:6px 10px;border-radius:8px;font-weight:700;font-size:13px}
    .tag.politica{background:#fcf0ef;color:#b33}
    .tag.cultura{background:#fff7ed;color:#b36a00}
    .tag.eventos{background:#eaf6ff;color:#0b6}
    .table-actions{display:flex;gap:8px}
    /* toasts */
    #toast-container{position:fixed;top:18px;right:18px;z-index:9999;display:flex;flex-direction:column;gap:10px}
    .toast{padding:12px 16px;border-radius:10px;color:#fff;box-shadow:0 8px 20px rgba(0,0,0,.12);display:flex;align-items:center;gap:10px}
    .toast.success{background:linear-gradient(90deg,#28a745,#20c997)}
    .toast.error{background:linear-gradient(90deg,#dc3545,#e74c3c)}
  </style>
</head>
<body>
  <div id="toast-container"></div>

  <!-- header mobile -->
  <header class="admin-header" id="admin-header">
    <button class="menu-toggle" id="menu-toggle"><i class="fas fa-bars"></i></button>
    <div class="logo-mobile"><i class="fas fa-newspaper" style="color:var(--laranja)"></i> GERA Admin</div>
    <div style="width:40px"></div>
  </header>

  <div class="admin-container">
    <!-- sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="logo-admin"><i class="fas fa-crown" style="color:var(--laranja)"></i> Painel GERA</div>

      <div class="nav-item active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></div>
      <div class="nav-item" data-page="noticias"><i class="fas fa-newspaper"></i><span>Notícias</span></div>
      <div class="nav-item" data-page="publicidade"><i class="fas fa-ad"></i><span>Anúncios</span></div>
      <div class="nav-item" data-page="usuarios"><i class="fas fa-users"></i><span>Usuários</span></div>
      <div style="height:12px"></div>
      <div class="nav-item" id="logout-btn"><i class="fas fa-sign-out-alt"></i><span>Sair</span></div>
    </aside>

    <!-- main -->
    <main class="main-content">
      <!-- LOGIN MODAL (força login) -->
      <div class="modal" id="login-modal" style="display:flex">
        <div class="modal-content" id="login-modal-content">
          <div class="modal-header"><h2>Área Administrativa</h2></div>
          <form id="login-form">
            <div style="display:grid;gap:10px">
              <input id="login-email" type="email" placeholder="E-mail" required style="padding:12px;border-radius:8px;border:1px solid #ddd">
              <input id="login-password" type="password" placeholder="Senha" required style="padding:12px;border-radius:8px;border:1px solid #ddd">
              <div style="display:flex;gap:10px;justify-content:flex-end">
                <button type="submit" class="btn btn-primary" id="login-submit"><i class="fas fa-sign-in-alt"></i> Entrar</button>
              </div>
              <div style="font-size:13px;color:#666;padding:6px;background:#fff7ed;border-radius:8px">
                Credenciais padrão: <strong>admin@admin.com</strong> / <strong>admin123</strong>
              </div>
              <div id="login-error" style="color:#c33;display:none"></div>
            </div>
          </form>
        </div>
      </div>

      <!-- DASHBOARD -->
      <section id="dashboard-page" class="page-content">
        <div class="header-bar">
          <h1><i class="fas fa-tachometer-alt" style="color:var(--laranja)"></i> Dashboard</h1>
          <div class="header-actions">
            <button class="btn btn-secondary" id="refresh-dashboard"><i class="fas fa-sync-alt"></i> Atualizar</button>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card"><h4>Usuários</h4><div id="total-usuarios" style="font-size:20px">--</div></div>
          <div class="stat-card"><h4>Notícias</h4><div id="total-noticias" style="font-size:20px">--</div></div>
          <div class="stat-card"><h4>Anúncios</h4><div id="total-anuncios" style="font-size:20px">--</div></div>
          <div class="stat-card"><h4>Última Atividade</h4><div id="ultima-atividade" style="font-size:14px;color:#666">--</div></div>
        </div>

        <h3>Atividades Recentes</h3>
        <div class="table-container" style="margin-top:10px;padding:0">
          <table id="acoes-table">
            <thead><tr><th>Usuário</th><th>Ação</th><th>Categoria</th><th>Data</th></tr></thead>
            <tbody>
              <tr><td colspan="4" class="not-found">Carregando...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- NOTÍCIAS -->
      <section id="noticias-page" class="page-content" style="display:none">
        <div class="header-bar">
          <h1><i class="fas fa-newspaper" style="color:var(--laranja)"></i> Notícias</h1>
          <div>
            <button class="btn btn-primary" id="add-noticia-btn"><i class="fas fa-plus"></i> Nova Notícia</button>
            <button class="btn btn-secondary" id="reload-noticias"><i class="fas fa-sync-alt"></i></button>
          </div>
        </div>

        <div class="table-container">
          <table id="noticias-table">
            <thead><tr><th>Título</th><th>Categoria</th><th>Data</th><th>Ações</th></tr></thead>
            <tbody><tr><td colspan="4" class="not-found">Carregando...</td></tr></tbody>
          </table>
        </div>
      </section>

      <!-- PUBLICIDADE -->
      <section id="publicidade-page" class="page-content" style="display:none">
        <div class="header-bar">
          <h1><i class="fas fa-ad" style="color:var(--laranja)"></i> Anúncios</h1>
          <div><button class="btn btn-primary" id="add-anuncio-btn"><i class="fas fa-plus"></i> Novo Anúncio</button></div>
        </div>

        <div class="table-container">
          <table id="anuncios-table">
            <thead><tr><th>Empresa</th><th>Status</th><th>Data</th><th>Ações</th></tr></thead>
            <tbody><tr><td colspan="4" class="not-found">Carregando...</td></tr></tbody>
          </table>
        </div>
      </section>

      <!-- USUÁRIOS -->
      <section id="usuarios-page" class="page-content" style="display:none">
        <div class="header-bar">
          <h1><i class="fas fa-users" style="color:var(--laranja)"></i> Usuários</h1>
          <div><button class="btn btn-secondary" id="export-leads"><i class="fas fa-file-export"></i> Exportar</button></div>
        </div>

        <div class="table-container">
          <table id="usuarios-table">
            <thead><tr><th>Nome</th><th>E-mail</th><th>Data</th></tr></thead>
            <tbody><tr><td colspan="3" class="not-found">Carregando...</td></tr></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- MODAIS: noticia / anuncio / confirm -->
  <div class="modal" id="noticia-modal">
    <div class="modal-content">
      <div class="modal-header"><h3 id="modal-noticia-title">Nova Notícia</h3><span class="close-modal" data-close="noticia-modal">&times;</span></div>
      <form id="noticia-form">
        <div class="form-grid">
          <div><label>Título *</label><input required id="titulo" type="text" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px"></div>
          <div><label>Categoria *</label><select id="categoria" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px">
            <option>Política</option><option>Cultura</option><option>Eventos</option><option>Comunidades</option><option>Serviços</option>
          </select></div>
          <div style="grid-column:1/-1"><label>Resumo *</label><textarea id="resumo" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px"></textarea></div>
          <div style="grid-column:1/-1"><label>Corpo *</label><textarea id="corpo" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;min-height:150px"></textarea></div>
          <div><label>Imagem</label><input id="imagem-noticia" type="file" accept="image/*"></div>
          <div class="image-preview" id="preview-noticia"><i class="fas fa-image" style="font-size:36px;color:#ddd"></i></div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button type="button" class="btn btn-secondary" data-close="noticia-modal">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="save-noticia-btn"><i class="fas fa-save"></i> Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="anuncio-modal">
    <div class="modal-content">
      <div class="modal-header"><h3>Novo Anúncio</h3><span class="close-modal" data-close="anuncio-modal">&times;</span></div>
      <form id="anuncio-form">
        <div class="form-grid">
          <div><label>Nome *</label><input id="nome-anuncio" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px"></div>
          <div><label>Empresa *</label><input id="empresa-anuncio" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px"></div>
          <div><label>E-mail *</label><input id="email-anuncio" type="email" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px"></div>
          <div><label>Telefone</label><input id="telefone-anuncio" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px"></div>
          <div><label>Tipo</label><select id="tipo-anuncio" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px"><option>banner</option><option>destaque</option><option>patrocinio</option></select></div>
          <div style="grid-column:1/-1"><label>Mensagem</label><textarea id="mensagem-anuncio" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px"></textarea></div>
          <div><label>Imagem</label><input id="imagem-anuncio" type="file" accept="image/*"></div>
          <div class="image-preview" id="preview-anuncio"><i class="fas fa-image" style="font-size:36px;color:#ddd"></i></div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button type="button" class="btn btn-secondary" data-close="anuncio-modal">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="save-anuncio-btn"><i class="fas fa-save"></i> Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="confirm-modal">
    <div class="modal-content">
      <div class="modal-header"><h3 id="confirm-title">Confirmação</h3><span class="close-modal" data-close="confirm-modal">&times;</span></div>
      <p id="confirm-message"></p>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="btn btn-secondary" id="confirm-cancel">Cancelar</button>
        <button class="btn btn-danger" id="confirm-action">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    // CONFIG
    const API_BASE = 'https://backend-gera-lrgo.onrender.com';
    const ADMIN_TOKEN_KEY = 'gera_admin_token';

    // TOAST
    function showToast(msg, type='success'){
      const c = document.getElementById('toast-container');
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.innerHTML = `<i class="fas ${type==='success'?'fa-check-circle':'fa-exclamation-circle'}"></i><div>${msg}</div>`;
      c.appendChild(t);
      setTimeout(()=>{ t.remove(); }, 3500);
    }

    // UTILS
    function formatDate(d){ try{ return new Date(d).toLocaleString('pt-BR'); }catch(e){return d} }

    // AUTH (local: admin@admin.com / admin123)
    function checkAuth(){
      const logged = sessionStorage.getItem('gera_admin_logged_in') === 'true';
      const loginModal = document.getElementById('login-modal');
      if(logged){ loginModal.style.display='none'; loadDashboardData(); loadRealtimeActions(); }
      else { loginModal.style.display='flex'; }
    }

    async function handleLogin(email, password){
      const btn = document.getElementById('login-submit');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entrando...';
      try{
        if(email==='admin@admin.com' && password==='admin123'){
          sessionStorage.setItem('gera_admin_logged_in','true');
          sessionStorage.setItem(ADMIN_TOKEN_KEY,'admin123');
          showToast('Login efetuado');
          document.getElementById('login-modal').style.display='none';
          loadDashboardData(); loadRealtimeActions();
        } else {
          throw new Error('Credenciais inválidas');
        }
      }catch(err){
        document.getElementById('login-error').style.display='block';
        document.getElementById('login-error').textContent = err.message || 'Erro';
      }finally{ btn.disabled=false; btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Entrar'; }
    }

    // UPLOAD helper (returns filename or url)
    async function uploadImage(file){
      if(!file) return null;
      const fd = new FormData(); fd.append('imagem', file);
      try{
        const res = await fetch(`${API_BASE}/api/upload`, { method:'POST', body: fd });
        if(!res.ok) throw new Error('Upload falhou');
        const data = await res.json();
        return data.filename || data.url || null;
      }catch(e){ console.error(e); showToast('Erro no upload', 'error'); return null; }
    }

    // CRUD NOTÍCIAS
    async function loadNoticias(){
      const tbody = document.querySelector('#noticias-table tbody');
      tbody.innerHTML = `<tr><td colspan="4" class="not-found">Carregando...</td></tr>`;
      try{
        const res = await fetch(`${API_BASE}/api/admin/news`);
        if(!res.ok) throw new Error('Erro');
        const noticias = await res.json();
        if(!Array.isArray(noticias) || noticias.length===0){ tbody.innerHTML = `<tr><td colspan="4" class="not-found">Nenhuma notícia</td></tr>`; return; }
        tbody.innerHTML = '';
        noticias.forEach(n=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td style="max-width:320px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${n.titulo}</td>
                          <td><span class="tag ${n.categoria.toLowerCase()}">${n.categoria}</span></td>
                          <td>${n.data?formatDate(n.data):'—'}</td>
                          <td><div class="table-actions">
                              <button class="btn table-edit" data-id="${n.id}"><i class="fas fa-edit"></i></button>
                              <button class="btn table-delete" data-id="${n.id}"><i class="fas fa-trash"></i></button>
                          </div></td>`;
          tbody.appendChild(tr);
        });

        // events
        document.querySelectorAll('.table-edit').forEach(b=>b.onclick=()=>openEditNoticia(b.dataset.id));
        document.querySelectorAll('.table-delete').forEach(b=>b.onclick=()=>confirmDelete('noticia', b.dataset.id));
      }catch(e){ console.error(e); tbody.innerHTML = `<tr><td colspan="4" class="not-found">Erro ao carregar</td></tr>`; }
    }

    async function handleNewNoticiaSubmit(e){
      e.preventDefault();
      const btn = document.getElementById('save-noticia-btn'); btn.disabled=true; btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Salvando...';
      try{
        const file = document.getElementById('imagem-noticia').files[0];
        const imagem = file ? await uploadImage(file) : null;
        const payload = {
          titulo: document.getElementById('titulo').value,
          categoria: document.getElementById('categoria').value,
          resumo: document.getElementById('resumo').value,
          corpo: document.getElementById('corpo').value,
          imagem
        };
        const res = await fetch(`${API_BASE}/api/add-news`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const data = await res.json();
        if(!res.ok) throw new Error(data.error || 'Erro');
        showToast('Notícia criada');
        closeModal('noticia-modal');
        loadNoticias();
      }catch(err){ console.error(err); showToast(err.message||'Erro','error'); }
      finally{ btn.disabled=false; btn.innerHTML='<i class="fas fa-save"></i> Salvar'; }
    }

    async function handleEditNoticiaSubmit(e){
      e.preventDefault();
      const btn = document.getElementById('save-noticia-btn'); btn.disabled=true; btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Atualizando...';
      try{
        const form = e.target;
        const id = form.dataset.editId;
        let imagem = form.dataset.currentImage || null;
        const file = document.getElementById('imagem-noticia').files[0];
        if(file) imagem = await uploadImage(file);
        const payload = {
          id, titulo: document.getElementById('titulo').value,
          categoria: document.getElementById('categoria').value,
          resumo: document.getElementById('resumo').value,
          corpo: document.getElementById('corpo').value,
          imagem
        };
        const res = await fetch(`${API_BASE}/api/update-news`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const data = await res.json();
        if(!res.ok) throw new Error(data.error||'Erro');
        showToast('Atualizado');
        closeModal('noticia-modal'); loadNoticias();
      }catch(err){ console.error(err); showToast(err.message||'Erro','error'); }
      finally{ btn.disabled=false; btn.innerHTML='<i class="fas fa-save"></i> Salvar'; }
    }

    async function openEditNoticia(id){
      try{
        const res = await fetch(`${API_BASE}/api/noticia?id=${id}`);
        if(!res.ok) throw new Error('Não encontrada');
        const noticia = await res.json();
        document.getElementById('modal-noticia-title').textContent = 'Editar Notícia';
        document.getElementById('titulo').value = noticia.titulo || '';
        document.getElementById('categoria').value = noticia.categoria || 'Política';
        document.getElementById('resumo').value = noticia.resumo || '';
        document.getElementById('corpo').value = noticia.corpo || '';
        const preview = document.getElementById('preview-noticia');
        if(noticia.imagem) preview.innerHTML = `<img src="${noticia.imagem.startsWith('http')?noticia.imagem:API_BASE+noticia.imagem}" style="width:100%;height:100%;object-fit:cover">`;
        document.getElementById('noticia-form').dataset.editId = noticia.id;
        document.getElementById('noticia-form').dataset.currentImage = noticia.imagem || '';
        // replace submit handler
        const form = document.getElementById('noticia-form');
        form.removeEventListener('submit', handleNewNoticiaSubmit);
        form.addEventListener('submit', handleEditNoticiaSubmit);
        openModal('noticia-modal');
      }catch(e){ console.error(e); showToast('Erro ao carregar notícia','error'); }
    }

    async function deleteNoticia(id){
      try{
        const res = await fetch(`${API_BASE}/api/delete-news/${id}`, { method:'DELETE', headers:{'Content-Type':'application/json'}, body: JSON.stringify({senha:'admin123'}) });
        const data = await res.json();
        if(!res.ok) throw new Error(data.error||'Erro');
        showToast('Notícia excluída');
        loadNoticias();
      }catch(e){ console.error(e); showToast('Erro','error'); }
    }

    // CRUD ANÚNCIOS
    async function loadAnuncios(){
      const tbody = document.querySelector('#anuncios-table tbody'); tbody.innerHTML=`<tr><td colspan="4" class="not-found">Carregando...</td></tr>`;
      try{
        const res = await fetch(`${API_BASE}/api/admin/ads`);
        if(!res.ok) throw new Error('Erro');
        const ads = await res.json();
        if(!Array.isArray(ads) || ads.length===0){ tbody.innerHTML=`<tr><td colspan="4" class="not-found">Nenhum anúncio</td></tr>`; return; }
        tbody.innerHTML = '';
        ads.forEach(a=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${a.empresa||a.nome}</td><td><span class="tag ${a.status==='ativo'?'ativo':'inativo'}">${a.status||'—'}</span></td><td>${a.data?formatDate(a.data):'—'}</td>
            <td><div class="table-actions"><button class="btn ad-delete" data-id="${a.id}"><i class="fas fa-trash"></i></button></div></td>`;
          tbody.appendChild(tr);
        });
        document.querySelectorAll('.ad-delete').forEach(b=>b.onclick=()=>confirmDelete('anuncio', b.dataset.id));
      }catch(e){ console.error(e); tbody.innerHTML=`<tr><td colspan="4" class="not-found">Erro ao carregar</td></tr>`; }
    }

    async function handleNewAnuncioSubmit(e){
      e.preventDefault();
      const btn = document.getElementById('save-anuncio-btn'); btn.disabled=true; btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Salvando...';
      try{
        const file = document.getElementById('imagem-anuncio').files[0];
        const imagem = file ? await uploadImage(file) : null;
        const payload = {
          nome: document.getElementById('nome-anuncio').value,
          empresa: document.getElementById('empresa-anuncio').value,
          email: document.getElementById('email-anuncio').value,
          telefone: document.getElementById('telefone-anuncio').value,
          tipo: document.getElementById('tipo-anuncio').value,
          mensagem: document.getElementById('mensagem-anuncio').value,
          imagem
        };
        const res = await fetch(`${API_BASE}/api/add-anuncio`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const data = await res.json();
        if(!res.ok) throw new Error(data.error||'Erro');
        showToast('Anúncio criado');
        closeModal('anuncio-modal'); loadAnuncios();
      }catch(err){ console.error(err); showToast(err.message||'Erro','error'); }
      finally{ btn.disabled=false; btn.innerHTML='<i class="fas fa-save"></i> Salvar'; }
    }

    async function deleteAnuncio(id){
      try{
        const res = await fetch(`${API_BASE}/api/delete-anuncio/${id}`, { method:'DELETE', headers:{'Content-Type':'application/json'}, body: JSON.stringify({senha:'admin123'}) });
        const data = await res.json();
        if(!res.ok) throw new Error(data.error||'Erro');
        showToast('Anúncio excluído'); loadAnuncios();
      }catch(e){ console.error(e); showToast('Erro','error'); }
    }

    // USUÁRIOS & DASHBOARD
    async function loadUsuarios(){
      const tbody = document.querySelector('#usuarios-table tbody'); tbody.innerHTML=`<tr><td colspan="3" class="not-found">Carregando...</td></tr>`;
      try{
        const res = await fetch(`${API_BASE}/api/admin/users`);
        if(!res.ok) throw new Error('Erro');
        const users = await res.json();
        if(!Array.isArray(users) || users.length===0){ tbody.innerHTML=`<tr><td colspan="3" class="not-found">Nenhum usuário</td></tr>`; return; }
        tbody.innerHTML = '';
        users.forEach(u=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${u.nome||'—'}</td><td>${u.email||'—'}</td><td>${u.data_cadastro?formatDate(u.data_cadastro):'—'}</td>`;
          tbody.appendChild(tr);
        });
      }catch(e){ console.error(e); tbody.innerHTML=`<tr><td colspan="3" class="not-found">Erro</td></tr>`; }
    }

    async function loadDashboardData(){
      try{
        const res = await fetch(`${API_BASE}/api/admin/dashboard`);
        if(!res.ok) throw new Error('Erro');
        const d = await res.json();
        document.getElementById('total-usuarios').textContent = d.totalUsuarios || 0;
        document.getElementById('total-noticias').textContent = d.totalNoticias || 0;
        document.getElementById('total-anuncios').textContent = d.totalAnuncios || 0;
        document.getElementById('ultima-atividade').textContent = formatDate(new Date());
      }catch(e){ console.error(e); }
    }

    async function loadRealtimeActions(){
      const tbody = document.querySelector('#acoes-table tbody'); tbody.innerHTML=`<tr><td colspan="4" class="not-found">Carregando...</td></tr>`;
      try{
        const res = await fetch(`${API_BASE}/api/realtime`);
        if(!res.ok) throw new Error('Erro');
        const actions = await res.json();
        if(!Array.isArray(actions) || actions.length===0){ tbody.innerHTML=`<tr><td colspan="4" class="not-found">Nenhuma atividade</td></tr>`; return; }
        tbody.innerHTML = '';
        actions.slice(0,8).forEach(a=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${a.usuario||'—'}</td><td>${a.acao||'—'}</td><td><span class="tag">${a.categoria||'—'}</span></td><td>${formatDate(a.data)}</td>`;
          tbody.appendChild(tr);
        });
      }catch(e){ console.error(e); tbody.innerHTML=`<tr><td colspan="4" class="not-found">Erro</td></tr>`; }
    }

    // MODAL UTILS
    function openModal(id){ document.getElementById(id).style.display='flex'; }
    function closeModal(id){ document.getElementById(id).style.display='none'; }
    function confirmDelete(type, id){
      document.getElementById('confirm-title').textContent = `Excluir ${type}`;
      document.getElementById('confirm-message').textContent = `Deseja realmente excluir este ${type}?`;
      openModal('confirm-modal');
      const act = document.getElementById('confirm-action');
      const cancel = document.getElementById('confirm-cancel');
      function onConfirm(){
        if(type==='noticia') deleteNoticia(id);
        if(type==='anuncio') deleteAnuncio(id);
        act.removeEventListener('click', onConfirm); cancel.removeEventListener('click', onCancel);
      }
      function onCancel(){ closeModal('confirm-modal'); act.removeEventListener('click', onConfirm); cancel.removeEventListener('click', onCancel); }
      act.addEventListener('click', onConfirm);
      cancel.addEventListener('click', onCancel);
    }

    // PREVIEW IMAGENS
    function previewImage(inputEl, previewEl){
      const file = inputEl.files && inputEl.files[0];
      if(!file){ previewEl.innerHTML = `<i class="fas fa-image" style="font-size:36px;color:#ddd"></i>`; return; }
      if(!file.type.startsWith('image/')){ showToast('Arquivo não é imagem','error'); inputEl.value=''; return; }
      if(file.size > 5*1024*1024){ showToast('Máx 5MB','error'); inputEl.value=''; return; }
      const rd = new FileReader();
      rd.onload = e => previewEl.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover">`;
      rd.readAsDataURL(file);
    }

    // NAV & events
    document.addEventListener('DOMContentLoaded', ()=>{
      checkAuth();

      // login
      document.getElementById('login-form').addEventListener('submit', (e)=>{
        e.preventDefault();
        const email = document.getElementById('login-email').value.trim();
        const pass = document.getElementById('login-password').value;
        handleLogin(email, pass);
      });

     // nav items
      document.querySelectorAll('.nav-item[data-page]').forEach(item => {
      item.addEventListener('click', () => {
      // ativa o item clicado
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      item.classList.add('active');

      // mostra a página correta
      document.querySelectorAll('.page-content').forEach(p => p.style.display = 'none');
      document.getElementById(item.dataset.page + '-page').style.display = 'block';

      // fecha sidebar no mobile
      if (window.innerWidth <= 900) document.querySelector('.sidebar').classList.remove('open');
        });
      });


      // logout
      document.getElementById('logout-btn').addEventListener('click', ()=>{
        if(confirm('Sair do painel?')){ sessionStorage.clear(); location.reload(); }
      });

      // Add noticia
      document.getElementById('add-noticia-btn').addEventListener('click', ()=>{
        document.getElementById('modal-noticia-title').textContent = 'Nova Notícia';
        document.getElementById('noticia-form').dataset.editId = '';
        document.getElementById('noticia-form').dataset.currentImage = '';
        document.getElementById('noticia-form').reset();
        document.getElementById('preview-noticia').innerHTML = `<i class="fas fa-image" style="font-size:36px;color:#ddd"></i>`;
        document.getElementById('noticia-form').removeEventListener('submit', handleEditNoticiaSubmit);
        document.getElementById('noticia-form').addEventListener('submit', handleNewNoticiaSubmit);
        openModal('noticia-modal');
      });

      // add anuncio
      document.getElementById('add-anuncio-btn').addEventListener('click', ()=>{
        document.getElementById('anuncio-form').reset();
        document.getElementById('preview-anuncio').innerHTML = `<i class="fas fa-image" style="font-size:36px;color:#ddd"></i>`;
        document.getElementById('anuncio-form').removeEventListener('submit', handleNewAnuncioSubmit);
        document.getElementById('anuncio-form').addEventListener('submit', handleNewAnuncioSubmit);
        openModal('anuncio-modal');
      });

      // modal close buttons
      document.querySelectorAll('.close-modal, [data-close]').forEach(btn=>{
        btn.addEventListener('click', ()=>closeModal(btn.dataset.close || btn.getAttribute('data-close')));
      });

      // previews
      document.getElementById('imagem-noticia').addEventListener('change', function(){ previewImage(this, document.getElementById('preview-noticia')); });
      document.getElementById('imagem-anuncio').addEventListener('change', function(){ previewImage(this, document.getElementById('preview-anuncio')); });

      // confirm modal close
      document.getElementById('confirm-cancel').addEventListener('click', ()=>closeModal('confirm-modal'));

      // hamburger (mobile)
      document.getElementById('menu-toggle').addEventListener('click', ()=>{
        document.querySelector('.sidebar').classList.toggle('open');
      });

      // refresh buttons
      document.getElementById('refresh-dashboard').addEventListener('click', ()=>{ loadDashboardData(); loadRealtimeActions(); showToast('Atualizado') });
      document.getElementById('reload-noticias').addEventListener('click', ()=>{ loadNoticias(); showToast('Notícias recarregadas') });

      // initial loads if already logged
      if(sessionStorage.getItem('gera_admin_logged_in')==='true'){ loadNoticias(); loadAnuncios(); loadUsuarios(); loadDashboardData(); loadRealtimeActions(); }
    });
  </script>
</body>
</html>
